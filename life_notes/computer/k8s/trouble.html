<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>trouble</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        background-color: #232629;
        color: #7a7c7d;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #7a7c7d;  padding-left: 4px; }
    div.sourceCode
      { color: #cfcfc2; background-color: #232629; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #cfcfc2; } /* Normal */
    code span.al { color: #95da4c; background-color: #4d1f24; font-weight: bold; } /* Alert */
    code span.an { color: #3f8058; } /* Annotation */
    code span.at { color: #2980b9; } /* Attribute */
    code span.bn { color: #f67400; } /* BaseN */
    code span.bu { color: #7f8c8d; } /* BuiltIn */
    code span.cf { color: #fdbc4b; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #3daee9; } /* Char */
    code span.cn { color: #27aeae; font-weight: bold; } /* Constant */
    code span.co { color: #7a7c7d; } /* Comment */
    code span.cv { color: #7f8c8d; } /* CommentVar */
    code span.do { color: #a43340; } /* Documentation */
    code span.dt { color: #2980b9; } /* DataType */
    code span.dv { color: #f67400; } /* DecVal */
    code span.er { color: #da4453; text-decoration: underline; } /* Error */
    code span.ex { color: #0099ff; font-weight: bold; } /* Extension */
    code span.fl { color: #f67400; } /* Float */
    code span.fu { color: #8e44ad; } /* Function */
    code span.im { color: #27ae60; } /* Import */
    code span.in { color: #c45b00; } /* Information */
    code span.kw { color: #cfcfc2; font-weight: bold; } /* Keyword */
    code span.op { color: #cfcfc2; } /* Operator */
    code span.ot { color: #27ae60; } /* Other */
    code span.pp { color: #27ae60; } /* Preprocessor */
    code span.re { color: #2980b9; background-color: #153042; } /* RegionMarker */
    code span.sc { color: #3daee9; } /* SpecialChar */
    code span.ss { color: #da4453; } /* SpecialString */
    code span.st { color: #f44f4f; } /* String */
    code span.va { color: #27aeae; } /* Variable */
    code span.vs { color: #da4453; } /* VerbatimString */
    code span.wa { color: #da4453; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <base href="../../../"> <meta http-equiv="Content-Type" content="text/html" charset="utf-8"> <link rel="stylesheet" type="text/css" href="css/page.css"> <link rel="stylesheet" type="text/css" href="css/gen.css"> <link rel="shortcut icon" href="image/yuan.ico" type="image/x-icon">
</head>
<body>
    <div class="blog-header">
    </div>
    <div class="blog-nav">
        <hr id="up"/>
        <button id="first" onclick="window.location.href='index.html'">首 页
        </button><button   onclick="window.location.href='blog.html'">博 客
        </button><button   onclick="window.location.href='read.html'">读 书
        </button><button   onclick="window.location.href='science.html'">科 学
        </button><button   onclick="window.location.href='literature.html'">文 哲
        </button><button   onclick="window.location.href='scope.html'">视 野
        </button><button  id="active" onclick="window.location.href='life_notes/index.html'">笔 记
        </button><button  onclick="window.location.href='index.html'">首 领</button>
        <hr id="down"/>
    </div>
    <div class="blog-body">
<a id="retindex" href="life_notes/computer/k8s/index.html">返回目录</a>
<header id="title-block-header">
<h1 class="title">trouble</h1>
</header>
<h2 id="常见问题">常见问题</h2>
<h3 id="pod长期处于pending">1. Pod长期处于Pending</h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="ex">kubectrl</span> describe pod/node xxx</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="ex">Events</span>:</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a>  <span class="ex">Type</span>     Reason            Age               From               Message</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a>  <span class="ex">----</span>     ------            ----              ----               -------</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a>  <span class="ex">Warning</span>  FailedScheduling  3s (x7 over 34s)  <span class="ex">default-scheduler</span>  0/3 nodes are available: 1 Insufficient cpu, 2 node(s) <span class="ex">didn</span><span class="st">&#39;t match node selector.</span></span></code></pre></div>
<p>查看pod信息，查看选择器是否正确 nodeSelector/nodeName是否正确</p>
<h3 id="readiness-probe-failed-http-probe-failed-with-statuscode-503">Readiness probe failed: HTTP probe failed with statuscode: 503</h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a>  <span class="ex">Normal</span>   Scheduled              10m                  default-scheduler      Successfully assigned istio-ingressgateway-645bfd8ddb-jzkm5 to 172.16.16.14</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a>  <span class="ex">Normal</span>   SuccessfulMountVolume  10m                  kubelet, 172.16.16.14  MountVolume.SetUp succeeded for volume <span class="st">&quot;ingressgatewaysdsudspath&quot;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a>  <span class="ex">Normal</span>   SuccessfulMountVolume  10m                  kubelet, 172.16.16.14  MountVolume.SetUp succeeded for volume <span class="st">&quot;ingressgateway-ca-certs&quot;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a>  <span class="ex">Normal</span>   SuccessfulMountVolume  10m                  kubelet, 172.16.16.14  MountVolume.SetUp succeeded for volume <span class="st">&quot;ingressgateway-certs&quot;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a>  <span class="ex">Normal</span>   SuccessfulMountVolume  10m                  kubelet, 172.16.16.14  MountVolume.SetUp succeeded for volume <span class="st">&quot;istio-ingressgateway-service-account-token-z4n6q&quot;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a>  <span class="ex">Normal</span>   SuccessfulMountVolume  10m                  kubelet, 172.16.16.14  MountVolume.SetUp succeeded for volume <span class="st">&quot;istio-certs&quot;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a>  <span class="ex">Normal</span>   Pulled                 10m                  kubelet, 172.16.16.14  Container image <span class="st">&quot;docker.io/istio/node-agent-k8s:1.1.3&quot;</span> already present on machine</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true"></a>  <span class="ex">Normal</span>   Created                10m                  kubelet, 172.16.16.14  Created container</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true"></a>  <span class="ex">Normal</span>   Started                10m                  kubelet, 172.16.16.14  Started container</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true"></a>  <span class="ex">Normal</span>   Pulled                 10m                  kubelet, 172.16.16.14  Container image <span class="st">&quot;docker.io/istio/proxyv2:1.1.3&quot;</span> already present on machine</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true"></a>  <span class="ex">Normal</span>   Created                10m                  kubelet, 172.16.16.14  Created container</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true"></a>  <span class="ex">Normal</span>   Started                10m                  kubelet, 172.16.16.14  Started container</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true"></a>  <span class="ex">Warning</span>  Unhealthy              42s (x299 over 10m)  <span class="ex">kubelet</span>, 172.16.16.14  Readiness probe failed: HTTP probe failed with statuscode: 503</span></code></pre></div>
<ol type="1">
<li>describe pod 报这个错误</li>
<li>尝试进入istio-system 下 polite 容器</li>
<li>重启polite</li>
</ol>
<p>原因是proxy访问polite不通。</p>
<h3 id="pod无法创建">2.Pod无法创建</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="co"># kubectl get deployment</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a><span class="ex">NAME</span>             READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a><span class="ex">details-v1</span>       0/1     0            0           4h6m</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a><span class="ex">productpage-v1</span>   0/1     0            0           4h6m</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a><span class="ex">ratings-v1</span>       0/1     0            0           4h6m</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a><span class="ex">reviews-v1</span>       0/1     0            0           4h6m</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a><span class="ex">reviews-v2</span>       0/1     0            0           4h6m</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a><span class="ex">reviews-v3</span>       0/1     0            0           4h6m</span></code></pre></div>
<pre class="shell"><code># kubectl get deployment details-v1 -o yaml
status:
  conditions:
  - lastTransitionTime: &quot;2020-07-20T03:52:59Z&quot;
    lastUpdateTime: &quot;2020-07-20T03:52:59Z&quot;
    message: Deployment does not have minimum availability.
    reason: MinimumReplicasUnavailable
    status: &quot;False&quot;
    type: Available
  - lastTransitionTime: &quot;2020-07-20T03:52:59Z&quot;
    lastUpdateTime: &quot;2020-07-20T03:52:59Z&quot;
    message: &#39;admission webhook &quot;sidecar-injector.istio.io&quot; denied the request: template:
      inject:140:7: executing &quot;inject&quot; at &lt;gt .ProxyConfig.Concurrency 0&gt;: error calling
      gt: invalid type for comparison&#39;
    reason: FailedCreate
    status: &quot;True&quot;
    type: ReplicaFailure
  - lastTransitionTime: &quot;2020-07-20T04:03:00Z&quot;
    lastUpdateTime: &quot;2020-07-20T04:03:00Z&quot;
    message: ReplicaSet &quot;details-v1-78db589446&quot; has timed out progressing.
    reason: ProgressDeadlineExceeded
    status: &quot;False&quot;
    type: Progressing
  observedGeneration: 1
  unavailableReplicas: 1</code></pre>
<p>查看是否开始</p>
<pre class="shell"><code># kubectl get namespace -L istio-injection
bookinfo          Active   124d   enabled
default           Active   125d   enabled
istio-system      Active   12d    disabled</code></pre>
<p>获取</p>
<pre class="shell"><code>#kubectl get mutatingwebhookconfiguration istio-sidecar-injector -o yaml
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {&quot;apiVersion&quot;:&quot;admissionregistration.k8s.io/v1beta1&quot;,&quot;kind&quot;:&quot;MutatingWebhookConfiguration&quot;,&quot;metadata&quot;:{&quot;annotations&quot;:{},&quot;labels&quot;:{&quot;app&quot;:&quot;sidecar-injector&quot;,&quot;install.operator.istio.io/owning-resource&quot;:&quot;installed-state&quot;,&quot;install.operator.istio.io/owning-resource-namespace&quot;:&quot;istio-system&quot;,&quot;istio.io/rev&quot;:&quot;default&quot;,&quot;operator.istio.io/component&quot;:&quot;Pilot&quot;,&quot;operator.istio.io/managed&quot;:&quot;Reconcile&quot;,&quot;operator.istio.io/version&quot;:&quot;1.6.3&quot;,&quot;release&quot;:&quot;istio&quot;},&quot;name&quot;:&quot;istio-sidecar-injector&quot;},&quot;webhooks&quot;:[{&quot;clientConfig&quot;:{&quot;caBundle&quot;:&quot;&quot;,&quot;service&quot;:{&quot;name&quot;:&quot;istiod&quot;,&quot;namespace&quot;:&quot;istio-system&quot;,&quot;path&quot;:&quot;/inject&quot;}},&quot;failurePolicy&quot;:&quot;Fail&quot;,&quot;name&quot;:&quot;sidecar-injector.istio.io&quot;,&quot;namespaceSelector&quot;:{&quot;matchLabels&quot;:{&quot;istio-injection&quot;:&quot;enabled&quot;}},&quot;rules&quot;:[{&quot;apiGroups&quot;:[&quot;&quot;],&quot;apiVersions&quot;:[&quot;v1&quot;],&quot;operations&quot;:[&quot;CREATE&quot;],&quot;resources&quot;:[&quot;pods&quot;]}],&quot;sideEffects&quot;:&quot;None&quot;}]}
  creationTimestamp: &quot;2020-04-29T01:30:22Z&quot;
  generation: 11
  labels:
    app: sidecar-injector
    install.operator.istio.io/owning-resource: installed-state
    install.operator.istio.io/owning-resource-namespace: istio-system
    istio.io/rev: default
    operator.istio.io/component: Pilot
    operator.istio.io/managed: Reconcile
    operator.istio.io/version: 1.6.3
    release: istio
  name: istio-sidecar-injector
  resourceVersion: &quot;7942709016&quot;
  selfLink: /apis/admissionregistration.k8s.io/v1/mutatingwebhookconfigurations/istio-sidecar-injector
  uid: 676f2599-f9fc-4fbf-8729-d368d3dd735b
webhooks:
- admissionReviewVersions:
  - v1beta1
  clientConfig:
    caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMzVENDQWNXZ0F3SUJBZ0lRUzBZWUdZVGVBcW9ydEVsenFZNHA5ekFOQmdrcWhraUc5dzBCQVFzRkFEQVkKTVJZd0ZBWURWUVFLRXcxamJIVnpkR1Z5TG14dlkyRnNNQjRYRFRJd01EY3dPREEzTkRJek5sb1hEVE13TURjdwpOakEzTkRJek5sb3dHREVXTUJRR0ExVUVDaE1OWTJ4MWMzUmxjaTVzYjJOaGJEQ0NBU0l3RFFZSktvWklodmNOCkFRRUJCUUFEZ2dFUEFEQ0NBUW9DZ2dFQkFNZDF1Q3l0YzNJM01iMmxBWTloVUw2b2UwNTZPMkZ4c1FwSVV5YU8KaCs4dkFhSnZZT3dxUkNKbjVDZHBLQ0Faem9LeVhKbkxvdVVlaWV3VUV4N2czVVN3djlZblFkT2xWMWUvR1VhMQpLaHcwRHhCRWIxdlExQ3BUTGdkRHdsMTBmcVh0cE1aTnZtY09hdmJwamxodlAxSUNHMktjQVlJRXkybEJtMUVSCjdjdjFHbGgraE1jdHFzeDV4c1lvcTNXaWUxYzQ3TWxCVkVlaDM5VUcwdEVtQXpMSEVuTDF5bzFhRHVIVHRuN2QKendHN21Na1hBN2c1anRVWmFCeHlxSWpORUV2dFRHb3UxbEYvZ0E2eHhjVkFyRlA0VWpKSWZpTmFlVnE4di9nMgpEZytSMG5wSjlwek9DV1dZQ3lXaU50SVZNSmNvbEs4N0VsWHVIYWFlQzc2VWJNa0NBd0VBQWFNak1DRXdEZ1lEClZSMFBBUUgvQkFRREFnSUVNQThHQTFVZEV3RUIvd1FGTUFNQkFmOHdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUIKQUdLbG5QTUtZbWUwV0lDM0pGeUFBY0k4b0FtRlFMNzVaQWsrbDk2WWw4Vk1ZTUI3VDlteFFSaTZ2czVZbElZeQp1ZDFqNTNEYzB5NVBjTU9UdzZXYzF0QkdqL1U0alArSm5DT1U3SXRwVTRPWmlZd3o2OEJvZGFJalVYWVJWVGpaClBVWk5ZZDA0aW5IMDJCQ1k5em9TaHdLaW1jSnE0bUlGWW9NRTN6WXRYdEY5Ry8zNTRiNG9tU1A1bzEzRXRUVk8KQUZTc0FxRWdiNGhoQURwUWt0TU01RE1iVHp6OWhQakNlREswTXRWQUt0dVNiTE5kVG1uazd1eHB5N3ZuQThLMgpTcEVNZlA4YmtDdGp6Q3NhRzFKOE80ZEJ5czByeXk3RWhrWHk2L1FVenVUVXlTYlp2WkhFZWlKelhmZVhlbFlXClNrRStjYnZ5WHdWQmVqdm1ObndXNERBPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    service:
      name: istiod
      namespace: istio-system
      path: /inject
      port: 443
  failurePolicy: Fail
  matchPolicy: Exact
  name: sidecar-injector.istio.io
  namespaceSelector:
    matchLabels:
      istio-injection: enabled
  objectSelector: {}
  reinvocationPolicy: Never
  rules:
  - apiGroups:
    - &quot;&quot;
    apiVersions:
    - v1
    operations:
    - CREATE
    resources:
    - pods
    scope: &#39;*&#39;
  sideEffects: None
  timeoutSeconds: 30</code></pre>
<p>获取配置</p>
<pre class="shell"><code># kubectl get cm istio-sidecar-injector -o yaml -n istio-system
      {{- if gt .ProxyConfig.Concurrency 0 }}
        - --concurrency
        - &quot;{{ .ProxyConfig.Concurrency }}&quot;
      {{- end -}}</code></pre>
<p>这里执行失败了</p>
<p><a href="https://istio.io/latest/docs/reference/config/istio.mesh.v1alpha1/#ProxyConfig">ProxyConfig</a></p>
<blockquote>
<p>concurrency - The number of worker threads to run. Default value is number of cores on the machine.</p>
</blockquote>
<p>目前删除这几句可以回复正常，问题在于为何拿不到配置?</p>
<pre class="shell"><code># kubectl get cm istio -o yaml -n istio-system
apiVersion: v1
data:
  mesh: |-
    accessLogEncoding: TEXT
    accessLogFile: /dev/stdout
    accessLogFormat: &quot;&quot;
    defaultConfig:
      concurrency: 2</code></pre>
<p><a href="https://istio.io/latest/docs/ops/common-problems/injection/">常见 inject 问题</a></p>
<h3 id="x509-certificate-has-expired-or-is-not-yet-valid">3. x509: certificate has expired or is not yet valid</h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a><span class="co"># 获取部署 </span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a><span class="ex">kubectl</span> get deployment</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a><span class="co">#然后 describe deployment</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true"></a><span class="co">#获取replicaset，这里有具体的错误信息</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true"></a><span class="ex">kubectl</span> get replicaset</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true"></a><span class="ex">kubectl</span> describe replicaset xxx</span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a><span class="fu">Name</span><span class="kw">:</span><span class="at">           eduiot-platform-v1-956d589bc</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a><span class="fu">Namespace</span><span class="kw">:</span><span class="at">      tj-edu-iot</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a><span class="fu">Selector</span><span class="kw">:</span><span class="at">       app=eduiot-platform,pod-template-hash=956d589bc,version=v1</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true"></a><span class="fu">Labels</span><span class="kw">:</span><span class="at">         app=eduiot-platform</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true"></a><span class="at">                pod-template-hash=956d589bc</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true"></a><span class="at">                version=v1</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true"></a><span class="fu">Annotations</span><span class="kw">:</span><span class="at">    deployment.kubernetes.io/desired-replicas: 1</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true"></a><span class="at">                </span><span class="fu">deployment.kubernetes.io/max-replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true"></a><span class="at">                </span><span class="fu">deployment.kubernetes.io/revision</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true"></a><span class="at">                </span><span class="fu">kubernetes.io/change-cause</span><span class="kw">:</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true"></a><span class="at">                  kubectl apply --filename=./eduiot-platform_kube_1597047540.yaml --namespace=tj-edu-iot --kubeconfig=/root/.kube/config --record=true</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true"></a><span class="fu">Controlled By</span><span class="kw">:</span><span class="at">  Deployment/eduiot-platform-v1</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true"></a><span class="fu">Replicas</span><span class="kw">:</span><span class="at">       0 current / 1 desired</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true"></a><span class="fu">Pods Status</span><span class="kw">:</span><span class="at">    0 Running / 0 Waiting / 0 Succeeded / 0 Failed</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true"></a><span class="fu">Pod Template</span><span class="kw">:</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true"></a><span class="at">  </span><span class="fu">Labels</span><span class="kw">:</span><span class="at">  app=eduiot-platform</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true"></a><span class="at">           pod-template-hash=956d589bc</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true"></a><span class="at">           version=v1</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true"></a><span class="at">  </span><span class="fu">Containers</span><span class="kw">:</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true"></a><span class="at">   </span><span class="fu">eduiot-platform</span><span class="kw">:</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true"></a><span class="at">    </span><span class="fu">Image</span><span class="kw">:</span><span class="at">        ccr.ccs.tencentyun.com/release-prod/eduiot-platform:P009M000C001B018SP002</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true"></a><span class="at">    </span><span class="fu">Ports</span><span class="kw">:</span><span class="at">        8090/TCP, 8080/TCP</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true"></a><span class="at">    </span><span class="fu">Host Ports</span><span class="kw">:</span><span class="at">   0/TCP, 0/TCP</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true"></a><span class="at">    </span><span class="fu">Environment</span><span class="kw">:</span><span class="at">  &lt;none&gt;</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true"></a><span class="at">    </span><span class="fu">Mounts</span><span class="kw">:</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true"></a><span class="at">      /data/log/eduiot-platform from eduiot-platform-log-dir (rw)</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true"></a><span class="at">      /data/service/eduiot-platform/conf/app.yaml from eduiot-platform-conf-vol (rw)</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true"></a><span class="at">  </span><span class="fu">Volumes</span><span class="kw">:</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true"></a><span class="at">   </span><span class="fu">eduiot-platform-log-dir</span><span class="kw">:</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true"></a><span class="at">    </span><span class="fu">Type</span><span class="kw">:</span><span class="at">    EmptyDir (a temporary directory that shares a pod&#39;s lifetime)</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true"></a><span class="at">    </span><span class="fu">Medium</span><span class="kw">:</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true"></a><span class="at">   </span><span class="fu">eduiot-platform-conf-vol</span><span class="kw">:</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true"></a><span class="at">    </span><span class="fu">Type</span><span class="kw">:</span><span class="at">      ConfigMap (a volume populated by a ConfigMap)</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true"></a><span class="at">    </span><span class="fu">Name</span><span class="kw">:</span><span class="at">      eduiot-platform-v1</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true"></a><span class="at">    </span><span class="fu">Optional</span><span class="kw">:</span><span class="at">  </span><span class="ch">false</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true"></a><span class="fu">Conditions</span><span class="kw">:</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true"></a><span class="at">  Type             Status  Reason</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true"></a><span class="at">  ----             ------  ------</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true"></a><span class="at">  ReplicaFailure   True    FailedCreate</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true"></a><span class="fu">Events</span><span class="kw">:</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true"></a><span class="at">  Type     Reason        Age                 From                   Message</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true"></a><span class="at">  ----     ------        ----                ----                   -------</span></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true"></a><span class="at">  </span><span class="fu">Warning  FailedCreate  15m (x20 over 54m)  replicaset-controller  Error creating</span><span class="kw">:</span><span class="at"> Internal error occurred: failed calling admission webhook &quot;sidecar-injector.istio.io&quot;: Post https://istio-sidecar-injector.istio-system.svc:443/inject?timeout=30s: x509: certificate has expired or is not yet valid</span></span></code></pre></div>
<p>重点看Event事件</p>
<blockquote>
<p><code>x509: certificate signed by unknown authority</code> errors are typically caused by an empty <code>caBundle</code> in the webhook configuration.</p>
</blockquote>
<blockquote>
<p>Verify the <code>caBundle</code> in the <code>mutatingwebhookconfiguration</code> matches the root certificate mounted in the <code>istiod</code> pod.</p>
</blockquote>
<div class="sourceCode" id="cb12"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a><span class="ex">kubectl</span> get mutatingwebhookconfiguration istio-sidecar-injector -o yaml -o jsonpath=<span class="st">&#39;{.webhooks[0].clientConfig.caBundle}&#39;</span> <span class="kw">|</span> <span class="ex">md5sum</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a><span class="ex">kubectl</span> -n istio-system get secret istio-galley-service-account-token-hwxw4 -o jsonpath=<span class="st">&#39;{.data.ca\.crt}&#39;</span> <span class="kw">|</span> <span class="ex">md5sum</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a><span class="co"># kubectl describe  deployment istio-sidecar-injector -n istio-system</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true"></a><span class="ex">Pod</span> Template:</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true"></a>  <span class="ex">Labels</span>:           app=sidecarInjectorWebhook</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true"></a>                    <span class="va">chart=</span>sidecarInjectorWebhook</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true"></a>                    <span class="va">heritage=</span>Tiller</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true"></a>                    <span class="va">istio=</span>sidecar-injector</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true"></a>                    <span class="va">release=</span>istio</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true"></a>  <span class="ex">Annotations</span>:      sidecar.istio.io/inject: false</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true"></a>  <span class="ex">Service</span> Account:  istio-sidecar-injector-service-account</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true"></a>  <span class="ex">Containers</span>:</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true"></a>   <span class="ex">sidecar-injector-webhook</span>:</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true"></a>    <span class="ex">Image</span>:      docker.io/istio/sidecar_injector:1.1.3</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true"></a>    <span class="ex">Port</span>:       <span class="op">&lt;</span>none<span class="op">&gt;</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true"></a>    <span class="ex">Host</span> Port:  <span class="op">&lt;</span>none<span class="op">&gt;</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true"></a>    <span class="ex">Args</span>: # istio/pilot/cmd/sidecar-injector/main.go 中定义</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true"></a>      <span class="ex">--caCertFile</span>=/etc/istio/certs/root-cert.pem</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true"></a>      <span class="ex">--tlsCertFile</span>=/etc/istio/certs/cert-chain.pem</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true"></a>      <span class="ex">--tlsKeyFile</span>=/etc/istio/certs/key.pem</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true"></a>      <span class="ex">--injectConfig</span>=/etc/istio/inject/config</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true"></a>      <span class="ex">--meshConfig</span>=/etc/istio/config/mesh</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true"></a>      <span class="ex">--healthCheckInterval</span>=2s</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true"></a>      <span class="ex">--healthCheckFile</span>=/health</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true"></a>    <span class="ex">Requests</span>:</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true"></a>      <span class="ex">cpu</span>:        10m</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true"></a>    <span class="ex">Liveness</span>:     exec [/usr/local/bin/sidecar-injector probe --probe-path=/health --interval=4s] delay=4s timeout=1s period=4s #success=1 #failure=3</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true"></a>    <span class="ex">Readiness</span>:    exec [/usr/local/bin/sidecar-injector probe --probe-path=/health --interval=4s] delay=4s timeout=1s period=4s #success=1 #failure=3</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true"></a>    <span class="ex">Environment</span>:  <span class="op">&lt;</span>none<span class="op">&gt;</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true"></a>    <span class="ex">Mounts</span>:</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true"></a>      <span class="ex">/etc/istio/certs</span> from certs (ro)</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true"></a>      <span class="ex">/etc/istio/config</span> from config-volume (ro)</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true"></a>      <span class="ex">/etc/istio/inject</span> from inject-config (ro)</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true"></a>  <span class="ex">Volumes</span>:</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true"></a>   <span class="ex">config-volume</span>:</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true"></a>    <span class="ex">Type</span>:      ConfigMap (a volume populated by a ConfigMap)</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true"></a>    <span class="ex">Name</span>:      istio</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true"></a>    <span class="ex">Optional</span>:  false</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true"></a>   <span class="ex">certs</span>:</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true"></a>    <span class="ex">Type</span>:        Secret (a volume populated by a Secret)</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true"></a>    <span class="ex">SecretName</span>:  istio.istio-sidecar-injector-service-account</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true"></a>    <span class="ex">Optional</span>:    false</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true"></a>   <span class="ex">inject-config</span>:</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true"></a>    <span class="ex">Type</span>:      ConfigMap (a volume populated by a ConfigMap)</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true"></a>    <span class="ex">Name</span>:      istio-sidecar-injector</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true"></a>    <span class="ex">Optional</span>:  false</span></code></pre></div>
<p>它证书是挂载的 istio.istio-sidecar-injector-service-account</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a><span class="co"># kubectl describe  deployment istio-galley  -n istio-system</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true"></a><span class="ex">Pod</span> Template:</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true"></a>  <span class="ex">Labels</span>:           app=galley</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true"></a>                    <span class="va">chart=</span>galley</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true"></a>                    <span class="va">heritage=</span>Tiller</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true"></a>                    <span class="va">istio=</span>galley</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true"></a>                    <span class="va">release=</span>istio</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true"></a>  <span class="ex">Annotations</span>:      sidecar.istio.io/inject: false</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true"></a>  <span class="ex">Service</span> Account:  istio-galley-service-account</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true"></a>  <span class="ex">Containers</span>:</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true"></a>   <span class="ex">galley</span>:</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true"></a>    <span class="ex">Image</span>:       docker.io/istio/galley:1.1.3</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true"></a>    <span class="ex">Ports</span>:       443/TCP, 15014/TCP, 9901/TCP</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true"></a>    <span class="ex">Host</span> Ports:  0/TCP, 0/TCP, 0/TCP</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true"></a>    <span class="ex">Command</span>:</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true"></a>      <span class="ex">/usr/local/bin/galley</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true"></a>      <span class="ex">server</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true"></a>      <span class="ex">--meshConfigFile</span>=/etc/mesh-config/mesh</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true"></a>      <span class="ex">--livenessProbeInterval</span>=1s</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true"></a>      <span class="ex">--livenessProbePath</span>=/healthliveness</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true"></a>      <span class="ex">--readinessProbePath</span>=/healthready</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true"></a>      <span class="ex">--readinessProbeInterval</span>=1s</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true"></a>      <span class="ex">--insecure</span>=true</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true"></a>      <span class="ex">--validation-webhook-config-file</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true"></a>      <span class="ex">/etc/config/validatingwebhookconfiguration.yaml</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true"></a>      <span class="ex">--monitoringPort</span>=15014</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true"></a>    <span class="ex">Requests</span>:</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true"></a>      <span class="ex">cpu</span>:        10m</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true"></a>    <span class="ex">Liveness</span>:     exec [/usr/local/bin/galley probe --probe-path=/healthliveness --interval=10s] delay=5s timeout=1s period=5s #success=1 #failure=3</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true"></a>    <span class="ex">Readiness</span>:    exec [/usr/local/bin/galley probe --probe-path=/healthready --interval=10s] delay=5s timeout=1s period=5s #success=1 #failure=3</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true"></a>    <span class="ex">Environment</span>:  <span class="op">&lt;</span>none<span class="op">&gt;</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true"></a>    <span class="ex">Mounts</span>:</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true"></a>      <span class="ex">/etc/certs</span> from certs (ro)</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true"></a>      <span class="ex">/etc/config</span> from config (ro)</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true"></a>      <span class="ex">/etc/mesh-config</span> from mesh-config (ro)</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true"></a>  <span class="ex">Volumes</span>:</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true"></a>   <span class="ex">certs</span>:</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true"></a>    <span class="ex">Type</span>:        Secret (a volume populated by a Secret)</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true"></a>    <span class="ex">SecretName</span>:  istio.istio-galley-service-account</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true"></a>    <span class="ex">Optional</span>:    false</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true"></a>   <span class="ex">config</span>:</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true"></a>    <span class="ex">Type</span>:      ConfigMap (a volume populated by a ConfigMap)</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true"></a>    <span class="ex">Name</span>:      istio-galley-configuration</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true"></a>    <span class="ex">Optional</span>:  false</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true"></a>   <span class="ex">mesh-config</span>:</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true"></a>    <span class="ex">Type</span>:      ConfigMap (a volume populated by a ConfigMap)</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true"></a>    <span class="ex">Name</span>:      istio</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true"></a>    <span class="ex">Optional</span>:  false</span></code></pre></div>
<p>它证书挂在 istio.istio-galley-service-account</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a><span class="co">#查看他们的证书</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true"></a><span class="ex">kubectl</span> get Secret istio.istio-galley-service-account -n istio-system -o jsonpath=<span class="st">&#39;{.data.root-cert\.pem}&#39;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true"></a><span class="ex">kubectl</span> get Secret istio.istio-sidecar-injector-service-account -n istio-system -o jsonpath=<span class="st">&#39;{.data.root-cert\.pem}&#39;</span></span></code></pre></div>
<p>找了一圈，结果是istio自己的bug</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a><span class="ex">kubectl</span> delete Secret istio-ca-secret -n istio-system</span></code></pre></div>
<p>官网原因在这里<a href="https://istio.io/latest/docs/ops/configuration/security/root-transition/">Extending Self-Signed Certificate Lifetime</a></p>
<p>阿里的一位哥们遇到了同样的事情 https://developer.aliyun.com/article/728018</p>
<blockquote>
<p>在Istio比较早期的版本中，自签名Ca证书有效期只有一年时间，如果使用老版本Istio超过一年，就会遇到这个问题。当证书过期之后，我们创建新的虚拟服务或者pod，都会因为CA证书过期而失败。而这时如果Citadel重启，它会读取过期证书并验证其有效性，就会出现以上Cidatel不能启动的问题。</p>
</blockquote>
<blockquote>
<p>这个Ca证书在K8s集群中，是以istio-ca-secret命名的secret，我们可以使用openssl解码证书来查看有效期。这个问题比较简单的处理方法，就是删除这个Secret，并重启Citadel，这时Citadel会走向新建和验证自签名Ca证书的逻辑并刷新Ca证书。或者参考以下官网处理方式。</p>
</blockquote>
<h3 id="重复打标签">4. 重复打标签</h3>
<p>使用–overwrite覆盖写即可</p>
<h3 id="cm重复创建报错">5. cm重复创建报错</h3>
<div class="sourceCode" id="cb17"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true"></a>[<span class="ex">root@VM-0-14-centos</span> cluster-istio]# kubectl create configmap node-grafana-configuration-dashboards --from-file=./node_exporter -n istio-system</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true"></a><span class="ex">Error</span> from server (AlreadyExists)<span class="bu">:</span> configmaps <span class="st">&quot;node-grafana-configuration-dashboards&quot;</span> already exists</span></code></pre></div>
<p>采用一个替换的策略</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true"></a><span class="ex">kubectl</span> create configmap node-grafana-configuration-dashboards --from-file=./node_exporter -n istio-system -o yaml --dry-run <span class="kw">|</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true"></a><span class="ex">kubectl</span> replace -f -</span></code></pre></div>
<p>可以解决重入问题，但是首次创建有问题</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true"></a>[<span class="ex">root@VM-0-14-centos</span> cluster-istio]# kubectl delete cm node-grafana-configuration-dashboards -n istio-system</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true"></a><span class="ex">configmap</span> <span class="st">&quot;node-grafana-configuration-dashboards&quot;</span> deleted</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true"></a>[<span class="ex">root@VM-0-14-centos</span> cluster-istio]# kubectl create configmap node-grafana-configuration-dashboards --from-file=./node_exporter -n istio-system -o yaml --dry-run <span class="kw">|</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true"></a><span class="ex">kubectl</span> replace -f -</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true"></a><span class="ex">Error</span> from server (NotFound)<span class="bu">:</span> error when replacing <span class="st">&quot;STDIN&quot;</span>: configmaps <span class="st">&quot;node-grafana-configuration-dashboards&quot;</span> not found</span></code></pre></div>
<p><a href="https://stackoverflow.com/questions/38216278/update-k8s-configmap-or-secret-without-deleting-the-existing-one">stackoverflow上找一种策略</a></p>
<div class="sourceCode" id="cb20"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true"></a><span class="ex">kubectl</span> create configmap node-grafana-configuration-dashboards --from-file=./node_exporter -n istio-system -o yaml --dry-run <span class="kw">|</span> <span class="ex">kubectl</span> apply -f - configmap/node-grafana-configuration-dashboards configured</span></code></pre></div>
<p>不好使。</p>
<p>github issues问题，有位给了一个技巧，用上下文。但是–context我们不支持（未使用）。</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true"></a><span class="ex">kubectl</span>  create configmap node-grafana-configuration-dashboards --from-file=./node_exporter -n istio-system -o yaml --dry-run <span class="kw">|</span> <span class="ex">kubectl</span> apply -f -</span></code></pre></div>
<p>too long</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true"></a><span class="ex">The</span> ConfigMap <span class="st">&quot;node-grafana-configuration-dashboards&quot;</span> is invalid: metadata.annotations: Too long: must have at most 262144 characters</span></code></pre></div>
<p>这个文件有50w字符。</p>
<p>不是办法的办法，就是用||运算符了</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true"></a><span class="ex">kubectl</span> create configmap node-grafana-configuration-dashboards --from-file=./node_exporter -n istio-system <span class="kw">||</span> <span class="ex">kubectl</span> create configmap node-grafana-configuration-dashboards --from-file=./node_exporter -n istio-system -o yaml --dry-run <span class="kw">|</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true"></a><span class="ex">kubectl</span> replace -f -</span></code></pre></div>
<p>###6.Envoy proxy is NOT ready: config not received from Pilot (is Pilot running?): cds updates: 0 successful, 0 rejected; lds updates: 0 successful, 0 rejected</p>
<p>Envoy收不到pilot的配置，导致无法正常启动。导致read探测接口异常。出现pod在run，但是ready为0.</p>
<footer>
    <style>
        a#backtop{
            margin-right:120px;
            font-size:18px;
            margin-bottom:30px;
        }
    </style>
    <a id="backtop" style="position:fixed;right:0;bottom:0">返回页顶</a>
    <script>
        backtop.onclick = function(){
            scrollTo(0,0);
        }
    </script>
</footer>
</div>
</body>
</html>
